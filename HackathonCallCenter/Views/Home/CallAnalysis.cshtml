@{
    ViewData["Title"] = "Анализ разговора";
}

@section Styles {
    <link rel="stylesheet" href="~/css/dashboard.css">
    <link rel="stylesheet" href="~/css/charts.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .upload-form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .upload-form {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .form-icon {
            font-size: 3rem;
            color: var(--primary-color);
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
        }

        .form-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .form-subtitle {
            color: #6b7280;
            font-size: 1.05rem;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 1.75rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

            .form-label i {
                color: var(--primary-color);
            }

        .form-control-custom {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #f9fafb;
            color: #111827;
        }

            .form-control-custom:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
                background: white;
            }

            .form-control-custom::placeholder {
                color: #9ca3af;
            }

        .form-hint {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

            .form-hint i {
                color: #9ca3af;
                margin-top: 0.125rem;
            }

        .btn-analyze {
            width: 100%;
            padding: 1.125rem;
            font-size: 1.125rem;
            font-weight: 600;
            background: var(--primary-color);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

            .btn-analyze:hover {
                background: #2563eb;
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
            }

            .btn-analyze:active {
                transform: translateY(0);
            }

            .btn-analyze:disabled {
                background: #9ca3af;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

        .form-divider {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            color: #9ca3af;
            font-size: 0.875rem;
        }

            .form-divider::before,
            .form-divider::after {
                content: '';
                flex: 1;
                height: 1px;
                background: #e5e7eb;
            }

            .form-divider span {
                padding: 0 1rem;
            }

        .example-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1.25rem;
            margin-top: 2rem;
            border-left: 4px solid var(--primary-color);
        }

        .example-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .example-code {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.875rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            color: #1f2937;
            overflow-x: auto;
            margin-top: 0.5rem;
        }

        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            display: none;
        }

            .error-message i {
                font-size: 0.875rem;
            }

        .input-with-validation {
            position: relative;
        }

            .input-with-validation.valid .form-control-custom {
                border-color: #10b981;
                background: #f0fdf4;
            }

            .input-with-validation.invalid .form-control-custom {
                border-color: #dc2626;
                background: #fef2f2;
            }

        .validation-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            display: none;
        }

        .input-with-validation.valid .validation-icon.fa-check-circle {
            display: block;
            color: #10b981;
        }

        .input-with-validation.invalid .validation-icon.fa-exclamation-circle {
            display: block;
            color: #dc2626;
        }

        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }

        .form-footer {
            text-align: center;
            margin-top: 2rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
    </style>
}

<div class="main-content">
    <!-- Хедер -->
    <div class="header" style="width: 898px;">
        <div class="header-title">
            <h1>Анализ разговора</h1>
            <p>Загрузите аудиофайл для детального AI-анализа</p>
        </div>
        <div class="header-actions">
            <a asp-controller="Home" asp-action="Calls" class="btn btn-secondary">
                <i class="fas fa-history"></i>
                История анализов
            </a>
            <div class="user-info">
                <div class="user-avatar">АИ</div>
                <div>
                    <div style="font-weight: 600;">Амридин Назаров</div>
                    <div style="font-size: 0.8rem; color: var(--gray-color);">Администратор</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Форма загрузки аудио -->
    <div class="upload-form-container">
        <div class="upload-form">
            <div class="form-header">
                <div class="form-icon">
                    <i class="fas fa-wave-square"></i>
                </div>
                <h2 class="form-title">AI Анализ аудиозаписи</h2>
                <p class="form-subtitle">
                    Введите ссылку на аудиофайл звонка и укажите оператора. Система выполнит транскрипцию,
                    анализ эмоций и предоставит детальный отчет.
                </p>
            </div>

            <form  method="post" action="@Url.Action("AddCall", "Home")">
                <!-- Поле для ссылки на аудио -->
                <div class="form-group">
                    <label class="form-label" for="audioUrl">
                        <i class="fas fa-link"></i>
                        Ссылка на аудиофайл
                    </label>
                    <div class="input-with-validation" id="audioUrlContainer">
                        <input type="url"
                               class="form-control-custom"
                               id="audioUrl"
                               name="url"
                               placeholder=""
                               required
                               value="">
                        <i class="fas fa-check-circle validation-icon"></i>
                        <i class="fas fa-exclamation-circle validation-icon"></i>
                    </div>
                    <div class="error-message" id="audioUrlError">
                        <i class="fas fa-exclamation-triangle"></i>
                        Пожалуйста, введите корректную ссылку на аудиофайл
                    </div>
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i>
                        Поддерживаемый форматы: OGG. Ссылка должна быть доступна для загрузки.
                    </div>
                    <div class="progress-bar" id="audioProgress">
                        <div class="progress-fill"></div>
                    </div>
                </div>

                <div class="form-divider">
                    <span>Данные оператора</span>
                </div>

                <!-- Поле для оператора -->
                <div class="form-group">
                    <label class="form-label" for="operatorName">
                        <i class="fas fa-user-headset"></i>
                        Оператор (имя и фамилия)
                    </label>
                    <div class="input-with-validation" id="operatorNameContainer">
                        <input type="text"
                               class="form-control-custom"
                               id="operatorName"
                               name="fullName"
                               placeholder="Например: Анна Иванова"
                               required
                               value="">
                        <i class="fas fa-check-circle validation-icon"></i>
                        <i class="fas fa-exclamation-circle validation-icon"></i>
                    </div>
                    <div class="error-message" id="operatorNameError">
                        <i class="fas fa-exclamation-triangle"></i>
                        Пожалуйста, укажите имя и фамилию оператора
                    </div>
                    <div class="form-hint">
                        <i class="fas fa-lightbulb"></i>
                        Укажите оператора, который вел этот разговор для персонализированного анализа
                    </div>
                </div>

                <!-- Кнопка анализа -->
                <button type="submit" class="btn-analyze" >
                    <i class="fas fa-robot"></i>
                    Запустить AI-анализ
                </button>
            </form>

            <!-- Пример ссылки -->
            <div class="example-section">
                <div class="example-title">
                    <i class="fas fa-code"></i>
                    Пример корректной ссылки:
                </div>
                <div class="example-code">
                    https://storage.yandexcloud.net/bucket-name/folder/call-recording-001.mp3?X-Amz-Algorithm=AWS4-HMAC-SHA256...
                </div>
                <div class="form-hint" style="margin-top: 0.75rem;">
                    <i class="fas fa-shield-alt"></i>
                    Все данные обрабатываются безопасно и не передаются третьим лицам
                </div>
            </div>

            <div class="form-footer">
                <p>
                    <i class="fas fa-clock"></i>
                    Среднее время анализа: 2-3 минуты
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('audioAnalysisForm');
            const audioUrlInput = document.getElementById('audioUrl');
            const operatorNameInput = document.getElementById('operatorName');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const audioUrlContainer = document.getElementById('audioUrlContainer');
            const operatorNameContainer = document.getElementById('operatorNameContainer');
            const audioUrlError = document.getElementById('audioUrlError');
            const operatorNameError = document.getElementById('operatorNameError');
            const audioProgress = document.getElementById('audioProgress');
            const progressFill = audioProgress.querySelector('.progress-fill');

            // Валидация URL аудио
            function isValidAudioUrl(url) {
                if (!url) return false;

                // Проверка формата URL
                try {
                    new URL(url);
                } catch {
                    return false;
                }

                // Проверка на аудио файлы (можно расширить)
                const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.mp4', '.webm'];
                return audioExtensions.some(ext => url.toLowerCase().includes(ext));
            }

            // Валидация имени оператора
            function isValidOperatorName(name) {
                if (!name) return false;

                // Имя должно содержать хотя бы одно пробельное разделение (имя и фамилия)
                const parts = name.trim().split(/\s+/);
                return parts.length >= 2 && parts.every(part => part.length > 1);
            }

            // Обновление состояния поля
            function updateFieldValidation(field, container, errorElement, isValid) {
                container.classList.remove('valid', 'invalid');
                errorElement.style.display = 'none';

                if (field.value.trim() === '') {
                    return;
                }

                if (isValid) {
                    container.classList.add('valid');
                } else {
                    container.classList.add('invalid');
                    errorElement.style.display = 'flex';
                }
            }

            // Проверка всей формы
            function validateForm() {
                const isAudioValid = isValidAudioUrl(audioUrlInput.value.trim());
                const isOperatorValid = isValidOperatorName(operatorNameInput.value.trim());

                updateFieldValidation(audioUrlInput, audioUrlContainer, audioUrlError, isAudioValid);
                updateFieldValidation(operatorNameInput, operatorNameContainer, operatorNameError, isOperatorValid);

                return isAudioValid && isOperatorValid;
            }

            // События ввода
            audioUrlInput.addEventListener('input', function() {
                updateFieldValidation(
                    audioUrlInput,
                    audioUrlContainer,
                    audioUrlError,
                    isValidAudioUrl(audioUrlInput.value.trim())
                );
            });

            operatorNameInput.addEventListener('input', function() {
                updateFieldValidation(
                    operatorNameInput,
                    operatorNameContainer,
                    operatorNameError,
                    isValidOperatorName(operatorNameInput.value.trim())
                );
            });

            // Обработка отправки формы
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                if (!validateForm()) {
                    // Показать ошибки
                    audioUrlInput.dispatchEvent(new Event('input'));
                    operatorNameInput.dispatchEvent(new Event('input'));
                    return;
                }

                // Показать прогресс
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Подготовка анализа...';
                audioProgress.style.display = 'block';

                // Анимация прогресса
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    progressFill.style.width = progress + '%';

                    if (progress >= 100) {
                        clearInterval(progressInterval);

                        // Сохраняем данные в localStorage для передачи на страницу анализа
                        const analysisData = {
                            audioUrl: audioUrlInput.value.trim(),
                            operatorName: operatorNameInput.value.trim(),
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem('callAnalysisData', JSON.stringify(analysisData));

                        // Перенаправляем на страницу анализа эмоций
                        window.location.href = '@Url.Action("AddCall", "Home")';
                    }
                }, 50);
            });

            // Загрузка сохраненных данных (если есть)
            const savedData = localStorage.getItem('callAnalysisData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.audioUrl) audioUrlInput.value = data.audioUrl;
                    if (data.operatorName) operatorNameInput.value = data.operatorName;

                    // Запускаем валидацию для отображения состояния
                    setTimeout(() => {
                        audioUrlInput.dispatchEvent(new Event('input'));
                        operatorNameInput.dispatchEvent(new Event('input'));
                    }, 100);
                } catch (e) {
                    console.error('Ошибка загрузки сохраненных данных:', e);
                }
            }
        });
    </script>
}